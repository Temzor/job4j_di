name: Java Code Quality

on:
  schedule:
    - cron: '0 8 * * 1'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 8:00
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run automated code improvements
        run: |
          echo "# ðŸ”§ Automated Code Improvements - $(date)" > CODE_IMPROVEMENTS.md
          echo "" >> CODE_IMPROVEMENTS.md
          
          # 1. ÐŸÐ¾Ð¸ÑÐº Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
          echo "## 1. ÐÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹" >> CODE_IMPROVEMENTS.md
          echo "" >> CODE_IMPROVEMENTS.md
          find . -name "*.java" -exec grep -l "import.*;" {} \; | while read file; do
            echo "**ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð°:** $file" >> CODE_IMPROVEMENTS.md
            grep "^import" "$file" | while read import_line; do
              class_name=$(echo "$import_line" | sed 's/.*\.\([^.]*\);/\1/')
              if ! grep -q "\b$class_name\b" "$file" 2>/dev/null; then
                echo "- âŒ $import_line" >> CODE_IMPROVEMENTS.md
              else
                echo "- âœ… $import_line" >> CODE_IMPROVEMENTS.md
              fi
            done
            echo "" >> CODE_IMPROVEMENTS.md
          done || echo "No Java files found" >> CODE_IMPROVEMENTS.md
          
          # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ
          echo "## 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ" >> CODE_IMPROVEMENTS.md
          echo "" >> CODE_IMPROVEMENTS.md
          echo "ÐšÐ»Ð°ÑÑÑ‹ Ð½Ðµ Ð² CamelCase:" >> CODE_IMPROVEMENTS.md
          find . -name "*.java" -exec grep -h "class [A-Za-z_][A-Za-z0-9_]*" {} \; | \
            grep -v "class [A-Z][a-zA-Z0-9]*" | head -10 >> CODE_IMPROVEMENTS.md || echo "Ð’ÑÐµ ÐºÐ»Ð°ÑÑÑ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ñ‹" >> CODE_IMPROVEMENTS.md
          
          # 3. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ ÐºÐ»Ð°ÑÑÐ¾Ð²
          echo "## 3. Ð”Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ ÐºÐ»Ð°ÑÑÐ¾Ð²" >> CODE_IMPROVEMENTS.md
          echo "" >> CODE_IMPROVEMENTS.md
          echo '```mermaid' >> CODE_IMPROVEMENTS.md
          echo 'classDiagram' >> CODE_IMPROVEMENTS.md
          find . -name "*.java" | head -5 | while read file; do
            class_name=$(basename "$file" .java)
            grep "extends\|implements" "$file" | head -1 | while read line; do
              parent=$(echo "$line" | grep -o "extends [A-Za-z_][A-Za-z0-9_]*\|implements [A-Za-z_][A-Za-z0-9_]*" | cut -d' ' -f2)
              if [ ! -z "$parent" ]; then
                echo "$class_name --> $parent" >> CODE_IMPROVEMENTS.md
              fi
            done
          done
          echo '```' >> CODE_IMPROVEMENTS.md

      - name: Create automated tests
        run: |
          # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ ÐºÐ»Ð°ÑÑÐ¾Ð² Ð±ÐµÐ· Ñ‚ÐµÑÑ‚Ð¾Ð²
          find . -name "*.java" | grep -v "Test.java" | grep -v "TestSuite" | while read java_file; do
            test_file="${java_file%.java}Test.java"
            if [ ! -f "$test_file" ]; then
              class_name=$(basename "$java_file" .java)
              package=$(grep "^package " "$java_file" | head -1 | sed 's/package //' | sed 's/;//')
          
              mkdir -p "$(dirname "$test_file")"
          
              echo "package $package;" > "$test_file"
              echo "" >> "$test_file"
              echo "import org.junit.jupiter.api.Test;" >> "$test_file"
              echo "import static org.junit.jupiter.api.Assertions.*;" >> "$test_file"
              echo "" >> "$test_file"
              echo "class ${class_name}Test {" >> "$test_file"
              echo "" >> "$test_file"
              echo "    @Test" >> "$test_file"
              echo "    void testExample() {" >> "$test_file"
              echo "        // TODO: Add tests for $class_name" >> "$test_file"
              echo "        assertTrue(true);" >> "$test_file"
              echo "    }" >> "$test_file"
              echo "}" >> "$test_file"
          
              echo "Ð¡Ð¾Ð·Ð´Ð°Ð½ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»: $test_file" >> CODE_IMPROVEMENTS.md
            fi
          done || echo "No Java files to test" >> CODE_IMPROVEMENTS.md

      - name: Commit improvements
        run: |
          git config --local user.email "code-quality-bot@example.com"
          git config --local user.name "Code Quality Bot"
          git add CODE_IMPROVEMENTS.md
          find . -name "*Test.java" -newer CODE_IMPROVEMENTS.md 2>/dev/null | xargs git add 2>/dev/null || true
          git commit -m "ðŸ”§ Code quality improvements: $(date)" || echo "No changes"
          git push